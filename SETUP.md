# 微信小程序云开发设置指南

## 1. 云开发环境设置

### 步骤1：开通云开发
1. 在微信开发者工具中，点击顶部菜单栏的"云开发"
2. 开通云开发服务（需要微信小程序账号）
3. 创建云环境（选择基础版即可，免费额度足够使用）

### 步骤2：获取环境ID
1. 在云开发控制台中，找到"设置" -> "环境设置"
2. 复制"环境ID"
3. 在 `app.js` 中，将 `env: 'my-env-id'` 替换为你的环境ID

```javascript
wx.cloud.init({
  env: 'your-env-id', // 替换为你的环境ID
  traceUser: true,
});
```

## 2. 创建云数据库集合

在云开发控制台的"数据库"中，创建以下集合：

### foods 集合
- 用于存储食物基础数据（所有用户共享）
- 权限设置：仅创建者可读写

### user_foods 集合
- 用于存储用户的食物记录
- 权限设置：仅创建者可读写（云函数会自动处理用户权限）

### users 集合（可选）
- 用于存储用户信息
- 权限设置：仅创建者可读写

## 3. 创建数据库索引

### foods 集合索引
- `name`: 唯一索引
- `category`: 普通索引

### user_foods 集合索引
- `_openid`: 普通索引
- `foodId`: 普通索引
- `_openid + foodId`: 联合唯一索引

## 4. 部署云函数

### 部署 getOpenId 云函数
1. 在微信开发者工具中，右键点击 `cloudfunctions/getOpenId` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

## 5. 初始化食物数据

首次运行小程序时，会自动初始化食物数据到云数据库的 `foods` 集合。

如果初始化失败，可以手动执行：
1. 在云开发控制台的"数据库"中，选择 `foods` 集合
2. 点击"导入"，选择 `app.js` 中的 `foodList` 数据（需要转换为JSON格式）

## 6. 测试

1. 编译并运行小程序
2. 首次打开会跳转到登录页面
3. 点击"微信授权登录"
4. 登录成功后，数据会自动保存到云数据库

## 注意事项

1. **环境ID**：必须正确配置，否则无法连接云数据库
2. **权限设置**：确保数据库集合的权限设置正确
3. **云函数**：必须部署 `getOpenId` 云函数才能获取用户openid
4. **首次运行**：首次运行会自动初始化食物数据，可能需要几秒钟

## 故障排查

### 问题1：无法连接云数据库
- 检查是否已开通云开发
- 检查环境ID是否正确
- 检查网络连接

### 问题2：获取openid失败
- 检查云函数是否已部署
- 检查云函数代码是否正确

### 问题3：数据无法保存
- 检查数据库集合权限设置
- 检查用户是否已登录
- 查看控制台错误信息


